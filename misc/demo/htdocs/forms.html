<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<style type="text/css">

.label {
    float : left;
    width : 200px;
}

</style>
<script type="text/javascript" src="/static/js/jquery.js"></script>
<script type="text/javascript" src="/static/js/json2.js"></script>
<script type="text/javascript" src="/core/Jackalope.js"></script>
<script type="text/javascript" src="/core/Jackalope/Util.js"></script>
<script type="text/javascript" src="/core/Jackalope/Schema.js"></script>
<script type="text/javascript" src="/core/Jackalope/Client.js"></script>
<script type="text/javascript" src="/core/Jackalope/Client/Binding.js"></script>
<script type="text/javascript">

$(document).ready(function () {

    var repo = new Jackalope.Schema.Repository ({
        spec      : new Jackalope.Schema.Spec({ spec_url : "/spec/spec.json" }),
        validator : new Jackalope.Schema.Validator ()
    });

    repo.register_schema(
        {
            "id"         : 'simple/person',
            "title"      : 'This is a simple person schema',
            "extends"    : { '$ref' : 'schema/web/service/crud' },
            "properties" : {
                "first_name" : { "type" : 'string' },
                "last_name"  : { "type" : 'string' },
                "age"        : { "type" : 'integer', "greater_than" : 0, "less_than" : 125 },
            }
        }
    );

    var resource_repo = new Jackalope.Client.Resource.Repository({
        base_url          : '/people',
        schema            : repo.get_compiled_schema_by_uri("simple/person"),
        schema_repository : repo
    });

    var ajax_error = function ( xhr, status, error ) {
        alert(xhr.status + ' ' + xhr.statusText + ' - ' + xhr.responseText);
    };

    var current_resource;

    resource_repo.read(
        1,
        function ( resource ) {
            current_resource = resource;
            var err_handler = function (e) { alert(e.message + " : " + e.reason) };
            var bindings = {
                first_name : new Jackalope.Client.Binding ({
                    element       : '#first_name',
                    resource      : resource,
                    property      : "first_name",
                    error_handler : err_handler
                }),
                last_name : new Jackalope.Client.Binding ({
                    element       : '#last_name',
                    resource      : resource,
                    property      : "last_name",
                    error_handler : err_handler
                }),
                age : new Jackalope.Client.Binding ({
                    element       : '#age',
                    resource      : resource,
                    property      : "age",
                    error_handler : err_handler,
                    transformer   : function (age) { return parseInt( age ) }
                }),
                label : new Jackalope.Client.Binding.Label({
                    element  : '#user',
                    resource : resource,
                    property : "first_name"
                })
            };

            resource.bind('update', function () {
                $('#debug').val( JSON.stringify( resource.body, null, '   ' ) );
            });

            resource.trigger('update');

        },
        ajax_error
    );

    $('#save').click(function () {
        resource_repo.edit(
            current_resource,
            function ( resource ) {
                alert("UPDATED from (" + current_resource.version + ") to (" + resource.version + ")")
                current_resource = resource;
            },
            ajax_error
        )
    });

});

</script>
</head>
<body>
<div>
    <div id="user"></div>
    <hr/>
    <div><div class="label">First Name</div><input type="text" id="first_name" /></div>
    <div><div class="label">Last Name</div><input type="text" id="last_name" /></div>
    <div><div class="label">Age</div><input type="text" id="age" /></div>
    <div><input type="button" id="save" value="Save"></div>
    <hr/>
    <div>
        <textarea id="debug" rows="8" cols="40"></textarea>
    </div>
</div>
</body>
</html>