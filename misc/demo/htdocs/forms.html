<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<style type="text/css">

.label {
    float : left;
    width : 200px;
}

</style>
<script type="text/javascript" src="/static/js/jquery.js"></script>
<script type="text/javascript" src="/static/js/json2.js"></script>
<script type="text/javascript" src="/core/Jackalope.js"></script>
<script type="text/javascript" src="/core/Jackalope/Util.js"></script>
<script type="text/javascript" src="/core/Jackalope/Schema.js"></script>
<script type="text/javascript" src="/core/Jackalope/Client.js"></script>
<script type="text/javascript" src="/core/Jackalope/Client/Binding.js"></script>
<script type="text/javascript" src="/core/Jackalope/Client/Resource.js"></script>
<script type="text/javascript" src="/core/Jackalope/Client/Controller.js"></script>
<script type="text/javascript">

function TableView ( opts ) {
    this.$table = $( opts["table_body"] );
    this.$row   = this.$table.find( opts["row_selector"] );
    this.$table.empty();

    var target       = opts["target"];
    var binding_spec = opts["binding_spec"];

    var collection   = target.get_collection();

    for (var i = 0; i < collection.length(); i++) {
        var element  = collection.get(i);
        var $new_row = this.$row.clone(true);

        for ( var selector in binding_spec ) {
            var property = binding_spec[ selector ];

            $new_row.find( selector ).html( element.get( property ) );

            (function ($r, s) {
                element.bind(
                    'update:' + property,
                    function ( r, v ) { $r.find( s ).html( v ) }
                );
            })($new_row, selector);
        }

        $new_row.click(
            (function (e) {
                return function () {
                    target.set_context( e )
                }
            })( element )
        );

        this.$table.append( $new_row );
    }
}

$(document).ready(function () {

    var repo = new Jackalope.Schema.Repository ({
        spec      : new Jackalope.Schema.Spec({ spec_url : "/spec/spec.json" }),
        validator : new Jackalope.Schema.Validator ()
    });

    repo.register_schema(
        {
            "id"         : 'simple/person',
            "title"      : 'This is a simple person schema',
            "extends"    : { '$ref' : 'schema/web/service/crud' },
            "properties" : {
                "first_name" : { "type" : 'string' },
                "last_name"  : { "type" : 'string' },
                "age"        : { "type" : 'integer', "greater_than" : 0, "less_than" : 125 },
            }
        }
    );

    var resource_repo = new Jackalope.Client.Resource.Repository({
        base_url          : '/people',
        schema            : repo.get_compiled_schema_by_uri("simple/person"),
        schema_repository : repo
    });

    resource_repo.list(
        {},
        function ( resources ) {

            var err_handler = function (e) { alert(e.message + " : " + e.reason) };

            var array_controller = new Jackalope.Client.ArrayController({
                collection : resources,
                bindings   : [
                    new Jackalope.Client.Binding.Label({ element : '#user', property : "first_name" }),
                    new Jackalope.Client.Binding ({
                        element       : '#first_name',
                        property      : "first_name",
                        error_handler : err_handler
                    }),
                    new Jackalope.Client.Binding ({
                        element       : '#last_name',
                        property      : "last_name",
                        error_handler : err_handler
                    }),
                    new Jackalope.Client.Binding ({
                        element       : '#age',
                        property      : "age",
                        error_handler : err_handler,
                        transformer   : function (age) { return parseInt( age ) }
                    })
                ]
            });

            var view = new TableView ({
                table_body   : '#table_view tbody',
                row_selector : 'tr',
                target       : array_controller,
                binding_spec : {
                    '.first_name' : 'first_name',
                    '.last_name'  : 'last_name'
                }
            });

            $('#save').click(function () {
                resource_repo.edit(
                    array_controller.context,
                    function ( resource ) {
                        console.log("UPDATED");
                        array_controller.context.version = resource.version;
                        array_controller.context.body = resource.body;
                    },
                    function ( xhr, status, error ) {
                        alert(xhr.status + ' ' + xhr.statusText + ' - ' + xhr.responseText)
                    }
                )
            });

        },
        function ( xhr, status, error ) {
            alert(xhr.status + ' ' + xhr.statusText + ' - ' + xhr.responseText)
        }
    );

});

</script>
</head>
<body>
<div>
    <table border="1" width="500" id="table_view">
        <thead>
            <tr><td>First Name</td><td>Last Name</td></tr>
        </thead>
        <tbody>
            <tr><td class="first_name"></td><td class="last_name"></td></tr>
        </tbody>
    </table>
    <hr/>
    <div id="user"></div>
    <hr/>
    <div><div class="label">First Name</div><input type="text" id="first_name" /></div>
    <div><div class="label">Last Name</div><input type="text" id="last_name" /></div>
    <div><div class="label">Age</div><input type="text" id="age" /></div>
    <div><input type="button" id="save" value="Save"></div>
    <hr/>
</div>
</body>
</html>