<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<style type="text/css">

.label {
    float : left;
    width : 200px;
}

.selected {
    background : #cccccc;
}

</style>
<script type="text/javascript" src="/static/js/jquery.js"></script>
<script type="text/javascript" src="/static/js/json2.js"></script>
<script type="text/javascript" src="/core/Jackalope.js"></script>
<script type="text/javascript" src="/core/Jackalope/Util.js"></script>
<script type="text/javascript" src="/core/Jackalope/Schema.js"></script>
<script type="text/javascript" src="/core/Jackalope/Client.js"></script>
<script type="text/javascript" src="/core/Jackalope/Client/Binding.js"></script>
<script type="text/javascript" src="/core/Jackalope/Client/Resource.js"></script>
<script type="text/javascript" src="/core/Jackalope/Client/Controller.js"></script>
<script type="text/javascript" src="/core/Jackalope/Client/View/TableView.js"></script>
<script type="text/javascript">

Jackalope.Client.Binding.Action = function (opts) {
    this.target  = opts["target"];
    this.action  = opts["action"];
    this.element = opts["element"];
    if (this.target) {
        this.init();
    }
}

Jackalope.Client.Binding.Action.prototype.init = function () {
    var self = this;
    $( this.element ).click(function () {
        self.target[self.action]()
    });
}

Jackalope.Client.Binding.Action.prototype.set_target = function (target) {
    this.target = target;
    this.init();
}

// -----------------------------------------------------------

function ResourceController ( opts ) {
    this.data_source   = opts["data_source"];
    this.resource_repo = opts["resource_repo"];
    this.actions       = opts['actions'];
    this.views         = opts['views'];
    this.outlets       = opts['outlets'];
}

ResourceController.prototype = new Jackalope.Client.Controller ();

ResourceController.prototype.set_data_source = function ( data_source ) {
    this.data_source = data_source;
};

ResourceController.prototype.setup = function () {
    var self = this;

    with (this.views) {
        table.set_data_source( this.data_source );
        table.bind('selected', function ( index ) {
            self.set_context( self.data_source.get( index ) );
        });
    }

    for (var name in this.actions) {
        this.actions[name].set_target( this );
    }

    this.bind('update:context', function () {
        $('#person_dialog').show();
        for (var name in self.outlets) {
            self.outlets[name].set_target( self.get_context() );
        }
    });

    this.bind('clear:context', function () {
        self.views.table.clear_selection();
        $('#person_dialog').hide();
        for (var name in self.outlets) {
            self.outlets[name].clear_target();
        }
    });
};

ResourceController.prototype.add_new_resource_to_context = function () {
    this.views.table.clear_selection();
    this.set_context( new Jackalope.Client.Resource({}) )
};

ResourceController.prototype.reload_table = function () {
    this.views.table.reload();
    this.clear_context();
};

ResourceController.prototype.save_current_context = function () {
    var self = this;
    this.resource_repo.create_or_edit(
        this.get_context(),
        function ( resource ) {
            console.log("UPDATED");
            self.data_source.add_or_update( resource );
            self.clear_context();
        },
        function ( xhr, status, error ) {
            alert(xhr.status + ' ' + xhr.statusText + ' - ' + xhr.responseText)
        }
    )
};

ResourceController.prototype.fetch_data_source = function () {
    var self = this;
    this.resource_repo.list(
        {},
        function ( resources ) {
            self.set_data_source( resources );
            self.setup();
        },
        function ( xhr, status, error ) {
            alert(xhr.status + ' ' + xhr.statusText + ' - ' + xhr.responseText)
        }
    )
};

// --------------------------------------------------------------------------

// load up our schema repository ...
var repo = new Jackalope.Schema.Repository ({
    spec      : new Jackalope.Schema.Spec({ spec_url : "/spec/spec.json" }),
    validator : new Jackalope.Schema.Validator ()
});

// register our schema (we should actually be getting this from the server)
repo.register_schema(
    {
        "id"         : 'simple/person',
        "title"      : 'This is a simple person schema',
        "extends"    : { '$ref' : 'schema/web/service/crud' },
        "properties" : {
            "first_name" : { "type" : 'string' },
            "last_name"  : { "type" : 'string' },
            "age"        : { "type" : 'integer', "greater_than" : 0, "less_than" : 125 },
        }
    }
);

var r_repo = new Jackalope.Client.Resource.Repository({
    base_url          : '/people',
    schema            : repo.get_compiled_schema_by_uri("simple/person"),
    schema_repository : repo
});

// ------------------------------------------------------------------------

$(document).ready(function () {

    var c = new ResourceController({
        resource_repo : r_repo,
        views : {
            table : new Jackalope.Client.View.TableView ({
                table_body   : '#table_view tbody',
                row_selector : 'tr',
                binding_spec : {
                    '.first_name' : 'first_name',
                    '.last_name'  : 'last_name',
                    '.age'        : 'age'
                }
            })
        },
        outlets : {
            first_name : new Jackalope.Client.Binding ({
                element  : '#first_name',
                property : "first_name"
            }),
            last_name : new Jackalope.Client.Binding ({
                element  : '#last_name',
                property : "last_name",
            }),
            age : new Jackalope.Client.Binding ({
                element     : '#age',
                property    : "age",
                transformer : function (age) { return parseInt( age ) }
            })
        },
        actions : {
            reload_table : new Jackalope.Client.Binding.Action ({
                action  : 'reload_table',
                element : '#reload'
            }),
            add_new : new Jackalope.Client.Binding.Action({
                action  : 'add_new_resource_to_context',
                element : '#add_new'
            }),
            cancel : new Jackalope.Client.Binding.Action({
                action  : 'clear_context',
                element : '#cancel'
            }),
            save : new Jackalope.Client.Binding.Action({
                action  : 'save_current_context',
                element : '#save'
            })
        }
    });

    c.fetch_data_source();
});

</script>
</head>
<body>
<div>
    <div><input type="button" id="add_new" value="Add New" /><input type="button" id="reload" value="Reload Table" /></div>
    <hr/>
    <table border="1" width="500" id="table_view">
        <thead>
            <tr><td>First Name</td><td>Last Name</td><td>Age</td></tr>
        </thead>
        <tbody>
            <tr><td class="first_name"></td><td class="last_name"></td><td class="age"></td></tr>
        </tbody>
    </table>
    <hr/>
    <div id="person_dialog" style="display:none">
        <form id="person_form">
        <div><div class="label">First Name</div><input type="text" id="first_name" /></div>
        <div><div class="label">Last Name</div><input type="text" id="last_name" /></div>
        <div><div class="label">Age</div><input type="text" id="age" /></div>
        <div><input type="button" id="save" value="Save">&nbsp;<input type="button" id="cancel" value="Cancel"></div>
        </form>
    </div>
    <hr/>
</div>
</body>
</html>